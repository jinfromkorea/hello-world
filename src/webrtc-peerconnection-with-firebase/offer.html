<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>offer with firebase</title>
  <script src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
</head>
<body>
  <div id="btnDiv">
    <button id="offerBtn" disabled>Offer</button>
  </div>
  <video id="localVideo" autoplay muted playsinline></video>
  <div id="msgDiv">
  </div>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script>
// Initialize Firebase
var config = {
    apiKey: "AIzaSyDKEYRybMQOAkpMZp2F3bTvQFboa2VJgrI",
    authDomain: "test-webrtc-56501.firebaseapp.com",
    databaseURL: "https://test-webrtc-56501.firebaseio.com",
    projectId: "test-webrtc-56501",
    storageBucket: "test-webrtc-56501.appspot.com",
    messagingSenderId: "1044697177062"
};
firebase.initializeApp(config);
var localStream;
var pc;
var servers = {'iceServers': [{'urls': 'stun:stun.services.mozilla.com'}, 
                              {'urls': 'stun:stun.l.google.com:19302'}, 
                              {'urls': 'turn:numb.viagenie.ca','credential': 'yujin','username': 'yujin@email.com'}]};

document.addEventListener('DOMContentLoaded', _showVideo);
function _showVideo(event){
    console.log(event);
    navigator.mediaDevices.getUserMedia({audio:true, video:true}).then( _handleStream ).catch( _handleError );
    firebase.database().ref('/test/offer').once('value', _readSdp);
}
function _readSdp(dataSnapshot){
    console.log('firebase', dataSnapshot.val());
    var cnt=0;
    dataSnapshot.forEach( data => cnt++ ); //console.log(data.val(), data.key)
    if ( cnt > 0 ){
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[ToDo] Offer 버튼을 클릭하세요.';
        document.getElementById('msgDiv').appendChild(new_EL);
    }
}
function _handleStream(stream){
    console.log(stream);
    localStream = document.getElementById('localVideo').srcObject = stream;
    document.getElementById('localVideo').addEventListener('loadedmetadata', _handleDOMEvent );
}
function _handleError(error){
    console.log(error);
    var new_EL = document.createElement("p");
    new_EL.innerHTML = error.name;
    document.getElementById('msgDiv').appendChild(new_EL);
}
function _handleDOMEvent(event){
    console.log(event.target.id, event);
    if( event.target.id === 'localVideo'){
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[info] video가 로드되었습니다. (width: ' + this.videoWidth +'px, height: ' + this.videoHeight + 'px)';
        document.getElementById('msgDiv').appendChild(new_EL);
        document.getElementById('offerBtn').disabled = false;
        document.getElementById('offerBtn').onclick = _handleDOMEvent;
    }else if( event.target.id === 'offerBtn'){
        firebase.database().ref('/test/offer').set(null);
        firebase.database().ref('/test/answer').set(null);
        pc = new RTCPeerConnection(servers);
        if(localStream){
            localStream.getTracks().forEach( track => pc.addTrack(track, localStream) );
        }
        pc.oniceconnectionstatechange = _handleIceConnectionState;
        pc.onicecandidate = _handleIceCandidate; //iPhone이 끼면.. 필요한가?
        pc.createOffer().then( offer => _handleOffer(offer, pc) );
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[info] 연결 대기중입니다.';
        document.getElementById('msgDiv').appendChild(new_EL);
    }
}
function _handleIceCandidate(event){
    console.log('pc', event);
    if ( event.candidate ) {
        var msg = firebase.database().ref('/test/ice').push({
            sender:'offer', 
            ice   :JSON.stringify(event.candidate) 
        });
        msg.remove();
    }else{
        console.log("Sent All Ice");
    }
}
function _handleIceConnectionState(event){
    console.log('pc', pc.iceConnectionState, event);
    if(pc.iceConnectionState === 'new'){
    }else if(pc.iceConnectionState === 'checking'){
    }else if(pc.iceConnectionState === 'connected'){
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[info] 연결 되었습니다.';
        document.getElementById('msgDiv').appendChild(new_EL);
    }else if(pc.iceConnectionState === 'completed'){
        document.getElementById('offerBtn').disabled = true;
    }else if(pc.iceConnectionState === 'disconnected'){
        document.getElementById('offerBtn').disabled = false;
        firebase.database().ref('/test/offer').set(null);
        firebase.database().ref('/test/answer').set(null);
        firebase.database().ref('/test/ice').off('child_added', _monitorIce);
        pc.close();
        document.getElementById('msgDiv').innerHTML='';
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[info] 연결이 끊어졌습니다.';
        document.getElementById('msgDiv').appendChild(new_EL);
    }else if(pc.iceConnectionState === 'closed'){
        var new_EL = document.createElement("p");
        new_EL.innerHTML = '[ToDo] Offer 버튼을 클릭하세요.';
        document.getElementById('msgDiv').appendChild(new_EL);
    }
}
function _handleOffer(offer, pc){
    console.log(offer, pc);
    pc.setLocalDescription(offer).then( () => {
        firebase.database().ref('/test/offer').push( {
            url      :window.location.href, 
            platform :navigator.platform, 
            userAgent:navigator.userAgent, 
            date     :new Date().toString(),
            sdp      :JSON.stringify(pc.localDescription) 
        });
        firebase.database().ref('/test/answer').on('child_added', _monitorAnswer);
        firebase.database().ref('/test/ice').on('child_added', _monitorIce);
    });
}
function _monitorAnswer(childSnapshot, prevChildKey){ 
    console.log('firebase', childSnapshot.val());
    pc.setRemoteDescription( new RTCSessionDescription( JSON.parse(childSnapshot.val().sdp) ) );

    var new_EL = document.createElement("p");
    new_EL.innerHTML = '[info] 연결중입니다.';
    document.getElementById('msgDiv').appendChild(new_EL);
    firebase.database().ref('/test/answer').off('child_added', _monitorAnswer);
}
function _monitorIce(childSnapshot, prevChildKey){ 
    console.log('firebase', childSnapshot.val());
    if(childSnapshot.val().sender==='answer'){
        pc.addIceCandidate( new RTCIceCandidate( JSON.parse(childSnapshot.val().ice) ) );
    }
}
  </script>
</body>
</html>