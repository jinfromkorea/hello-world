<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <title>answer with firebase</title>
</head>
<body>
  <div id="btnDiv">
    <button id="answerBtn">Answer</button>
  </div>
  <video id="remoteVideo" autoplay playsinline></video>
  <div id="msgDiv">
  </div>
  <script src="https://www.gstatic.com/firebasejs/4.4.0/firebase.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script>
// Initialize Firebase
var config = {
    apiKey: "AIzaSyDKEYRybMQOAkpMZp2F3bTvQFboa2VJgrI",
    authDomain: "test-webrtc-56501.firebaseapp.com",
    databaseURL: "https://test-webrtc-56501.firebaseio.com",
    projectId: "test-webrtc-56501",
    storageBucket: "test-webrtc-56501.appspot.com",
    messagingSenderId: "1044697177062"
};
firebase.initializeApp(config);

var pc = new RTCPeerConnection();
pc.ontrack = function(e){ 
    document.getElementById('remoteVideo').srcObject = e.streams[0];
};
document.getElementById('answerBtn').onclick = _answer;

function _answer(event){
    console.log(event);
    firebase.database().ref('/test/offer/sdp').once('value', _readSdp);
}
function _readSdp(snapshot){
    console.log(JSON.parse(snapshot.val()).sdp);
    pc.setRemoteDescription( new RTCSessionDescription( JSON.parse(snapshot.val()).sdp ) 
    ).then( () => pc.createAnswer() 
    ).then( answer => pc.setLocalDescription( answer ) 
    ).then( () => firebase.database().ref('/test/answer/sdp').set( JSON.stringify({'sdp':pc.localDescription})) );
}
firebase.database().ref('/test/offer').on('child_removed', function(childSnapshot, prevChildKey){ 
    var new_EL = document.createElement("p");
    new_EL.innerHTML = 'offer 정보가 변경되었습니다. answer 버튼을 클릭하세요.';
    document.getElementById('msgDiv').appendChild(new_EL);
});
  </script>
</body>
</html>